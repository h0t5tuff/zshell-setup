#!/usr/bin/env zsh
# Location: ~/sanity

emulate -L zsh
setopt pipefail
setopt nonomatch

# üß™ Mode selection
mode="brief"
case "${1:-}" in
  ""|--brief) mode="brief" ;;
  --full) mode="full" ;;
  *) echo "Usage: sanity [--brief|--full]"; exit 2 ;;
esac

want_py="/opt/homebrew/opt/python@3.12/libexec/bin/python3"

hr() { [[ "$mode" == "full" ]] && echo -e "\nüîπ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"; }
section() { [[ "$mode" == "full" ]] && { hr; echo "üì¶ $1"; } }

# üîç PATH analysis
typeset -a path_entries
path_entries=(${(s/:/)PATH})
typeset -A seen
typeset -a missing dups

for p in $path_entries; do
  [[ -z "$p" ]] && continue
  [[ -d "$p" ]] || missing+=("$p")
  (( seen[$p]++ )) && dups+=("$p")
done

typeset -a ignore_missing=(
  "/var/run/com.apple.security.cryptexd/codex.system/bootstrap/usr/local/bin"
  "/var/run/com.apple.security.cryptexd/codex.system/bootstrap/usr/bin"
  "/var/run/com.apple.security.cryptexd/codex.system/bootstrap/usr/appleinternal/bin"
  "/opt/pmk/env/global/bin"
)
missing=(${missing:#(${(j:|:)~ignore_missing})})

# üêç Python
found_py=$(which python3 2>/dev/null)
py_version=$(python3 -V 2>/dev/null)
py_exe=$(python3 -c 'import sys; print(sys.executable)' 2>/dev/null)

# üì¶ pip & pipx
pipx_path=$(which pipx 2>/dev/null)
pipx_default_py=$(pipx environment 2>/dev/null | awk -F= '/PIPX_DEFAULT_PYTHON/{print $2}' | head -n1)
pipx_apps_py=$(pipx list 2>/dev/null | awk '/installed using Python/ {print $NF}' | head -n1)

# üç∫ Homebrew
brew_path=$(which brew 2>/dev/null)
brew_prefix=$(brew --prefix 2>/dev/null)
brew_ver=$(brew --version 2>/dev/null | head -n1)

# üß¨ Physics vars
ROOTSYS_v="${ROOTSYS:-}"
GEANT4_BASE_v="${GEANT4_BASE:-}"
Geant4_DIR_v="${Geant4_DIR:-}"
REMAGE_PREFIX_v="${REMAGE_PREFIX:-}"
BXDECAY0_PREFIX_v="${BXDECAY0_PREFIX:-}"

# üßæ Brief mode summary
if [[ "$mode" == "brief" ]]; then
  py_ok=$([[ "$found_py" == "$want_py" ]] && echo 1 || echo 0)
  pipx_ok=$([[ -n "$pipx_path" ]] && echo 1 || echo 0)
  g4_ok=$([[ -n "$GEANT4_BASE_v" ]] && echo 1 || echo 0)
  root_ok=$([[ -n "$ROOTSYS_v" ]] && echo 1 || echo 0)

  echo -e "üß† \033[1mSanity\033[0m  ZSH=$ZSH_VERSION  ARCH=$(uname -m)  FLAVOR=${ENV_FLAVOR:-unset}"
  echo -e "üìÇ PATH: missing_dirs=${#missing}  dup_entries=${#${(u)dups}}"
  echo -e "üêç Python: ${found_py:-not found}  ${py_version:-}"
  echo -e "üì¶ Pipx: ${pipx_path:-not found}  default=${pipx_default_py:-?}  app=${pipx_apps_py:-?}"
  echo -e "üç∫ Brew: ${brew_path:-not found}  prefix=${brew_prefix:-?}"

  echo -n "‚úÖ Status: "
  [[ "$py_ok" -eq 1 ]] && echo -n "PY=ok " || echo -n "PY=check "
  [[ "$pipx_ok" -eq 1 ]] && echo -n "PIPX=ok " || echo -n "PIPX=missing "
  [[ "$g4_ok" -eq 1 ]] && echo -n "G4=ok " || echo -n "G4=unset "
  [[ "$root_ok" -eq 1 ]] && echo -n "ROOT=ok " || echo -n "ROOT=unset "
  (( ${#missing} == 0 )) && echo "PATH=ok" || echo "PATH=warn"

  exit 0
fi

# üßæ Full mode
section "üñ•Ô∏è Shell"
echo "ZSH:       $ZSH_VERSION"
echo "ARCH:      $(uname -m)"
echo "FLAVOR:    ${ENV_FLAVOR:-unset}"
echo "PWD:       $PWD"

section "üìÇ PATH Entries"
for i in {1..${#path_entries}}; do
  printf "%2d. %s\n" $i "$path_entries[$i]"
done

if (( ${#missing} )); then
  echo -e "\n‚ö†Ô∏è  Missing PATHs:"
  print -rl -- $missing | sed 's/^/  - /'
else
  echo "‚úÖ All PATH entries exist"
fi

if (( ${#dups} )); then
  echo -e "\n‚ö†Ô∏è  Duplicate PATH entries:"
  print -rl -- ${(u)dups} | sed 's/^/  - /'
else
  echo "‚úÖ No duplicate PATH entries"
fi

section "üêç Python"
echo "which: $found_py"
echo "version: $py_version"
echo "sys.executable: $py_exe"
if [[ "$found_py" == "$want_py" ]]; then
  echo "‚úÖ python3 matches configured version"
else
  echo "‚ö†Ô∏è  python3 mismatch"
  echo "  expected: $want_py"
  echo "  current : $found_py"
fi

section "üì¶ Pipx & Pip"
echo "pipx: $pipx_path"
echo "pipx default python: ${pipx_default_py:-unknown}"
echo "pipx installed apps use: ${pipx_apps_py:-unknown}"
[[ "$pipx_default_py" != "$py_exe" ]] && echo "‚ö†Ô∏è  pipx uses different python than shell"

section "üîß Build & Runtime Paths"
for var in CMAKE_PREFIX_PATH PKG_CONFIG_PATH DYLD_FALLBACK_LIBRARY_PATH; do
  echo "$var:"
  if [[ -z "${(P)var}" ]]; then
    echo "  unset"
  else
    print -rl -- ${(s/:/)${(P)var}} | sed 's/^/  - /'
  fi
done

section "üß¨ Physics Stack"
echo "ROOTSYS:         $ROOTSYS_v"
echo "GEANT4_BASE:     $GEANT4_BASE_v"
echo "Geant4_DIR:      $Geant4_DIR_v"
echo "REMAGE_PREFIX:   $REMAGE_PREFIX_v"
echo "BXDECAY0_PREFIX: $BXDECAY0_PREFIX_v"

section "üîç Tool Checks"
for tool in brew root geant4-config cmake pkg-config; do
  echo "$tool: $(command -v $tool 2>/dev/null || echo not found)"
done

section "üß™ Runtime Tests"
command -v root >/dev/null && root -b -q -e 'gSystem->Exit(0);' >/dev/null 2>&1 \
  && echo "‚úÖ root runs" || echo "‚ùå root failed"
command -v geant4-config >/dev/null && geant4-config --version >/dev/null 2>&1 \
  && echo "‚úÖ geant4-config runs" || echo "‚ùå geant4-config failed"

section "üßæ Summary"
(( ${#missing} == 0 )) && echo "‚úÖ PATH: ok" || echo "‚ö†Ô∏è  PATH: ${#missing} missing dirs"
[[ "$found_py" == "$want_py" ]] && echo "‚úÖ PYTHON: ok" || echo "‚ö†Ô∏è  PYTHON: mismatch"
[[ -n "$pipx_path" ]] && echo "‚úÖ PIPX: present" || echo "‚ö†Ô∏è  PIPX: missing"
[[ -n "$GEANT4_BASE_v" ]] && echo "‚úÖ GEANT4: set" || echo "‚ö†Ô∏è  GEANT4: unset"
[[ -n "$ROOTSYS_v" ]] && echo "‚úÖ ROOT: set" || echo "‚ö†Ô∏è  ROOT: unset"

hr
echo "‚úÖ Sanity check complete."